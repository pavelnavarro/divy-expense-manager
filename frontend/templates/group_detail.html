{% extends "layout.html" %}
{% block title %}Group Details | Divy{% endblock %}

{% block content %}
<h2 id="groupName">Loading…</h2>
<p>Created by: <span id="groupCreator">‑</span></p>

<section>
  <h3>Group Balances</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Member</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody id="balancesTableBody"></tbody>
  </table>
</section>

<section>
  <h3>Members</h3>
  <ul id="memberList"></ul>
</section>

<div class="actions mt-3">
  <a href="{{ url_for('frontend.add_expense_page') }}" class="btn btn-primary">Add Shared Expense</a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const groupId         = window.location.pathname.split('/').pop();
  const groupNameEl     = document.getElementById('groupName');
  const groupCreatorEl  = document.getElementById('groupCreator');
  const memberList      = document.getElementById('memberList');
  const balancesBody    = document.getElementById('balancesTableBody');
  let groupMembers = [];

  async function loadGroup() {
    const res = await fetch(`/api/shared/group/${groupId}`);
    const g   = await res.json();

    groupNameEl.textContent = g.name;
    groupCreatorEl.textContent = g.members.find(u => u.id === g.created_by)?.username || '—';
    groupMembers = g.members;

    g.members.forEach(m => {
      const li = document.createElement('li');
      li.textContent = m.username;
      memberList.appendChild(li);
    });
  }

  async function loadBalances() {
    const res = await fetch(`/api/shared/group/${groupId}/balances`);
    const { net_balances } = await res.json();

    balancesBody.innerHTML = '';
    for (const [uid, amount] of Object.entries(net_balances)) {
      const user = groupMembers.find(u => u.id == uid);
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      const tdAmount = document.createElement('td');

      tdName.textContent = user?.username || `User ${uid}`;
      tdAmount.textContent = amount >= 0
        ? `is owed $${amount.toFixed(2)}`
        : `owes $${Math.abs(amount).toFixed(2)}`;

      tr.appendChild(tdName);
      tr.appendChild(tdAmount);
      balancesBody.appendChild(tr);
    }
  }

  loadGroup().then(loadBalances);
});
</script>
{% endblock %}
